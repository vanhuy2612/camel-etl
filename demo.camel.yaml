- route:
    nodePrefixId: route-25b
    id: route-8cb6
    from:
      uri: kafka
      id: from-f15d
      parameters:
        topic: '{{KAFKA_TOPIC}}'
        groupId: '{{KAFKA_GROUPID}}'
        brokers: '{{KAFKA_BROKER}}'
        clientId: '{{KAFKA_CLIENTID}}'
      steps:
        - setHeader:
            name: FIELDS_PROJECTION
            expression:
              js:
                expression: "// thêm project cho câu lệnh mongoDB\r\n// let key = \"CamelMongoDbFieldsProjection\";\r\n// let headers = {\"_id\": 1, \"other\": 1};\r\n// exchange.getIn().setHeader(key, JSON.stringify(headers));\r\n// console.log(\"Get Projection Header\", exchange.getIn().getHeader(key));\r\n// exchange.getIn().getHeader(key);\r\n\r\n// thêm filter cho câu lệnh update\r\nlet filterKey = \"CamelMongoDbCriteria\";\r\nlet payload = (JSON.parse(exchange.getIn().getBody())).data;\r\nlet symbol = payload.symbol;\r\nlet query = {\r\n    symbol: symbol,\r\n}\r\nexchange.getIn().setHeader(filterKey, JSON.stringify(query));\r\nconsole.log(\"Get Filter Header\", exchange.getIn().getHeader(filterKey));\r\nexchange.getIn().getHeader(filterKey);"
                id: js-c416
            id: setHeader-a091
        - setBody:
            expression:
              js:
                expression: "// Câu lệnh append dữ liệu vào mảng\r\nlet payload = (JSON.parse(exchange.getIn().getBody())).data;\r\nlet data = payload?.data || [];\r\nbody = {\r\n    $push: {\r\n        data: { $each: data }\r\n    }\r\n}\r\nexchange.getIn().setBody(JSON.stringify(body));\r\nexchange.getIn().getBody();"
                id: js-36a1
            id: setBody-dce0
        - to:
            uri: mongodb
            id: to-f36d
            parameters:
              connectionBean: '{{MONGODB_URL}}'
              collection: '{{MONGODB_COLLECTION}}'
              database: '{{MONGODB_DATABASE}}'
              hosts: '{{MONGODB_HOST}}'
              operation: update
              outputType: DocumentList
              authSource: '{{MONGODB_AUTHSOURCE}}'
              password: '{{MONGODB_PASSWORD}}'
              username: '{{MONGODB_USERNAME}}'
        - setBody:
            expression:
              js:
                expression: console.log(exchange.getIn().getBody());
                id: js-e16b
            id: setBody-2417
